<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html"; charset="utf-8" />
	<title>EPAM-Task-Test</title>

	<!-- Viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	<!-- Favicon -->
	<link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">

	<!-- Normalize -->
	<link rel="stylesheet" type="text/css" href="css/normalize.css">

	<!-- jQuery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

	<!-- BOOTSTRAP -->
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<!-- Optional theme -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
	<!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<!-- Local bootstrap -->
	<!-- <link rel="stylesheet" type="text/css" href="bootstrap-3.3.7-dist/css/bootstrap.min.css"> -->
	<!-- <link rel="stylesheet" type="text/css" href="bootstrap-3.3.7-dist/css/bootstrap-theme.min.css"> -->
	<!-- <script type="text/javascript" src="bootstrap-3.3.7-dist/js/bootstrap.min.js"></script> -->

	
	<!-- ===================================================== -->
	<!-- STYLE -->
	<!-- ===================================================== -->
	<style type="text/css">

		.main-title { 
			text-align: center;
			margin: 25px 0;
		}

		.top-UI {
			margin-bottom: 10px;
		}

		.element-right {
			float: right;
		}
		.error-label {
			text-align: center;
		}

		.off-element {
			display: none;
		}
		.on-element {

		}

		/* Table */
		.table-caret {
			cursor: pointer;
		}
		.table-caret-reversed {
			
		}
		.table-count {
			float: right;
			text-align: center;

			background-color: #2ae42a;

			width: 25px;
			height: 25px;

			border-radius: 4px;
		}
		.table-actions {
			text-align: center;
		}
	</style>
</head>
<body>

	<!-- ===================================================== -->
	<!-- TITLE -->
	<!-- ===================================================== -->
	<h1 class="main-title">Перечень товаров</h1>
	<br>

	<!-- ===================================================== -->
	<!-- CONTENT -->
	<!-- ===================================================== -->
	<div class="container">
		<div class="row top-UI">
			<div class="form-group">
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<input type="text" class="form-control" id="inputSearch" value="" placeholder="Поиск по товарам">
				</div>

				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<button type="submit" class="btn btn-default" id="buttonSearch">Search</button>
				</div>

				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<button type="button" class="btn btn-default element-right" data-toggle="modal" data-target="#modalAdd">+ Add New</button>
				</div>
			</div>
		</div>

		<div class="load" id="load"></div>

		<table class="table table-bordered">
			<thead>
				<tr>
					<td> Name <span class="" id="nameCaretReversed"><span class="caret table-caret" id="sortName"></span></span></td>
					<td> Price <span class="" id="priceCaretReversed"><span class="caret table-caret" id="sortPrice"></span></span></td>
					<td> Actions </td>
				</tr>
			</thead>
			<tbody id="result"></tbody>
		</table>

	</div>

	<!-- ===================================================== -->
	<!-- MODALS -->
	<!-- ===================================================== -->
	<!-- Add New -->
	<div class="modal fade" id="modalAdd" tabindex="-1" role="dialog" aria-labelledby="modalLabelAdd">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="modalLabelAdd">Add New</h4>
				</div>

				<div class="modal-body">
					<div class="form-group">
						<label for="inputName" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label">Name:</label>
						<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 top-UI">
							<input type="text" class="form-control" id="inputNewName" placeholder="Товар №">
							<p class="bg-danger error-label off-element" id="errorAddName">Incorrect Name</p>
						</div>
					</div>
					<br>
					<br>
					<div class="form-group">
						<label for="inputCount" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label">Count:</label>
						<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 top-UI">
							<input type="text" class="form-control" id="inputNewCount" placeholder="1">
							<p class="bg-danger error-label off-element" id="errorAddCount">Incorrect Count</p>
						</div>
					</div>
					<br>
					<br>
					<div class="form-group">
						<label for="inputPrice" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label">Price:</label>
						<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
							<input type="text" class="form-control" id="inputNewPrice" placeholder="$12,123,343.25">
							<p class="bg-danger error-label off-element" id="errorAddPrice">Incorrect Price</p>
						</div>
					</div>
					<br>
					<br>
					<br>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-default" id="addNewElement">Add</button>
					<!-- <button type="button" class="btn btn-primary">Save changes</button> -->
				</div>
			</div>
		</div>
	</div>
	<!-- Edite -->
	<div class="modal fade" id="modalEdite" tabindex="-1" role="dialog" aria-labelledby="modalLabelEdit">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="modalLabelUpdate">Update</h4>
				</div>

				<div class="modal-body">
					<div class="form-group">
						<label for="inputName" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label">Name:</label>
						<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 top-UI">
							<input type="text" class="form-control" id="inputUpdateName" value="">
							<p class="bg-danger error-label off-element" id="errorUpdateName">Incorrect Name</p>
						</div>
					</div>
					<br>
					<div class="form-group">
						<label for="inputCount" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label">Count:</label>
						<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 top-UI">
							<input type="text" class="form-control" id="inputUpdateCount" value="">
							<p class="bg-danger error-label off-element" id="errorUpdateCount">Incorrect Count</p>
						</div>
					</div>
					<br>
					<div class="form-group">
						<label for="inputPrice" class="col-xs-2 col-sm-2 col-md-2 col-lg-2 control-label">Price:</label>
						<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">
							<input type="text" class="form-control" id="inputUpdatePrice" value="">
							<p class="bg-danger error-label off-element" id="errorUpdatePrice">Incorrect Price</p>
						</div>
					</div>
					<br>
					<br>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" id="updateElement">Update</button>
					<!-- <button type="button" class="btn btn-primary">Save changes</button> -->
				</div>
			</div>
		</div>
	</div>
	<!-- Delete -->
	<div class="modal fade" id="modalDelete" tabindex="-1" role="dialog" aria-labelledby="modalLabelDelete">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title" id="labelDelete">Delete</h4>
				</div>

				<div class="modal-body">
					<div class="form-group">
						<label >Are you sure you want to perform this action?</label>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" id="deleteElement">Yes</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">No</button>
				</div>
			</div>
		</div>
	</div>


	<!-- ===================================================== -->
	<!-- SCRIPTS -->
	<!-- ===================================================== -->
	<script type="text/javascript">
		// по завершению загрузки страницы
		$(document).ready(function() {
			var showData = $('#result'),
				load = $('#load');

			var request;

			var elementArr = [];

			var ascendingName = false,
				descendingName = true;
			var ascendingPrice = false,
				descendingPrice = true;

			var countElementsOfArr = 0;

			var idElement,
				numberElement;


			// class element
			function elementList(id, name, count, price) {
				this.id = id;
				this.name = name;
				this.count = count;
				this.price = price;
			};
			elementList.prototype.print = function() {
				console.log("id:", this.id);
				console.log("name:", this.name);
				console.log("count:", this.count);
				console.log("price:", this.price);
			};


			/* Загрузка и инициализация товаров */
			(function() {
				// загрузку JSON данных из файла listOfProducts.json и инициализация массива объектами(элементами списка)
				$.getJSON('listOfProducts.json', function(data) {
					$.each(data.products, function(key, value) {
						var idProduct = idNumber();
						// вывод в таблицу
						elementContent(value.name, value.count, value.price, idProduct);

						// создание объекта элемента списка и добавление в массив
						var product = new elementList(idProduct, value.name, value.count, value.price);
						// добавление в массив
						elementArr.push(product);
					});
				});
				// выводим/обновляем список товаров
				// updateContent();
			})();
			
			
			/* 
			* 	Events 	*
			* 			*/

			/* Поиск по запросу */
			$('#buttonSearch').click(function() {
				request = $('#inputSearch').val();

				// формирование и вывод данных
				updateContent(request);
			});


			/* Сортировка по имени */
			$('#sortName').click(function() {
				if (descendingName) {
					ascendingName = true;
					descendingName = false;
				} else {
					ascendingName = false,
					descendingName = true;
				}

				var countArr = [],
					countArrView = [];

				function compareNumbers(a, b) {
					return a - b;
				}


				// копируем массив
				for (var i = 0; i < elementArr.length; i++) {
					countArr[i] = elementArr[i].name;
				}

				// сортируем
				// по возрастанию
				if (ascendingName) {
					// изменение положение каретки 
					$('#nameCaretReversed').addClass("dropup");

					countArr.sort();

				// по убыванию
				} else {
					// изменение положение каретки 
					$('#nameCaretReversed').removeClass("dropup");

					countArr.sort(function (a, b) {
						return b.localeCompare(a);
					});

				}

				// сообщение о загрузке
				load.text('Loading...');
				// удаление предыдущего списка
				showData.empty();
				// вывод
				for (var i = 0; i < elementArr.length; i++) {
					for (var j = 0; j < elementArr.length; j++) {
						if ((countArr[i] == elementArr[j].name) && (countArrView[j] != true)) {
							if (request == '' || request == undefined) {
								elementContent(elementArr[j].name, elementArr[j].count, elementArr[j].price);

								countArrView[j] = true;

								break;
							} else {
								if (elementArr[j].name.toLowerCase().indexOf(request.toLowerCase()) > -1) {
									elementContent(elementArr[j].name, elementArr[j].count, elementArr[j].price);

									countArrView[j] = true;

									break;
								} 
							}
						}
					}
				}
				// удаление сообщения о загрузке 
				load.empty();
			});


			/* Сортировка по цене */
			$('#sortPrice').click(function() {
				if (descendingPrice) {
					ascendingPrice = true;
					descendingPrice = false;
				} else {
					ascendingPrice = false,
					descendingPrice = true;
				}
				
				var countArr = [],
					countArrView = [],
					tmp;


				// копируем массив
				for (var i = 0; i < elementArr.length; i++) {
					countArr[i] = elementArr[i].price;
				}

				// сортируем
				// по возрастанию
				if (ascendingPrice) {
					// изменение положение каретки 
					$('#priceCaretReversed').addClass("dropup");

					for (var i = countArr.length - 1; i > 0; i--) {
						for (var j = 0; j < i; j++) {
							if (Number(countArr[j]) > Number(countArr[j+1])) {
								tmp = countArr[j];
								countArr[j] = countArr[j+1];
								countArr[j+1] = tmp;
							}
						}
					}
				// по убыванию
				} else {
					// изменение положение каретки 
					$('#priceCaretReversed').removeClass("dropup");

					for (var i = countArr.length - 1; i > 0; i--) {
						for (var j = 0; j < i; j++) {
							if (Number(countArr[j]) < Number(countArr[j+1])) {
								tmp = countArr[j];
								countArr[j] = countArr[j+1];
								countArr[j+1] = tmp;
							}
						}
					}
				}

				// сообщение о загрузке
				load.text('Loading...');
				// удаление предыдущего списка
				showData.empty();
				// вывод
				for (var i = 0; i < countArr.length; i++) {
					for (var j = 0; j < elementArr.length; j++) {
						if ((countArr[i] == elementArr[j].price) && (countArrView[j] != true)) {
							if (request == '' || request == undefined) {
								elementContent(elementArr[j].name, elementArr[j].count, elementArr[j].price);

								countArrView[j] = true;

								break;
							} else {
								if (elementArr[j].name.toLowerCase().indexOf(request.toLowerCase()) > -1) {
									elementContent(elementArr[j].name, elementArr[j].count, elementArr[j].price);

									countArrView[j] = true;

									break;
								}
							}
						}
					}
				}
				// удаление сообщения о загрузке 
				load.empty();
			});


			/* Добавление нового элемента */
			$('#addNewElement').click(function() {
				var validName = validateName($('#inputNewName').val()),
					validCount = validateCount($('#inputNewCount').val()),
					validPrice = validatePrice($('#inputNewPrice').val());

				// убрать предыдущие ошибки
				$('#errorAddName').addClass('off-element');
				$('#errorAddCount').addClass('off-element');
				$('#errorAddPrice').addClass('off-element');

				$('#addNewElement').removeAttr('data-dismiss');


				if (validName && validCount && validPrice) {
					var countElement = {
						"name": $('#inputNewName').val(),
						"count": $('#inputNewCount').val(),
						"price": $('#inputNewPrice').val()
					};

					var product = new elementList(idNumber(), countElement.name, countElement.count, countElement.price);
					elementArr.push(product);

					$('#addNewElement').attr('data-dismiss', 'modal');

					updateContent();
				}

				// вывод сообщения об ошибке
				if (!validName) {
					$('#errorAddName').removeClass('off-element');
				}
				if (!validCount) {
					$('#errorAddCount').removeClass('off-element');
				}
				if (!validPrice) {
					$('#errorAddPrice').removeClass('off-element');
				}
			});


			/* Изменение и Удаление выбранного элемента */
			$('#result').click(function(elem) {
				idElement = elem.target.id;
				for (var i = 0; i < elementArr.length; i++) {
					if (elementArr[i].id[2] == idElement[2]) {
						numberElement = i;
						break;
					}
				}

				if (idElement[3] == 'E') {
					// изменение товара
					
					// добавление в поля форм данных текущего элемента
					$('#inputUpdateName').val(elementArr[numberElement].name);
					$('#inputUpdateCount').val(elementArr[numberElement].count);
					$('#inputUpdatePrice').val(elementArr[numberElement].price);


										
				} else {
					// удаление
					
					// сообщение о названии удаляемого продукта
					// $('#labelDelete').val($('#labelDelete').val() + " " + elementArr[numberElement].name);
					
					
				}
			});
			// обновление списка(на правку)
			$('#updateElement').click(function() {
				var validName = validateName($('#inputUpdateName').val()),
					validCount = validateCount($('#inputUpdateCount').val()),
					validPrice = validatePrice($('#inputUpdatePrice').val());

				// убрать предыдущие ошибки
				$('#errorUpdateName').addClass('off-element');
				$('#errorUpdateCount').addClass('off-element');
				$('#errorUpdatePrice').addClass('off-element');

				$('#updateElement').removeAttr('data-dismiss');


				if (validName && validCount && validPrice) {
					elementArr[numberElement].name = $('#inputUpdateName').val();
					elementArr[numberElement].count = $('#inputUpdateCount').val();
					elementArr[numberElement].price = $('#inputUpdatePrice').val();

					$('#updateElement').attr('data-dismiss', 'modal');

					updateContent();
				}

				// вывод сообщения об ошибке
				if (!validName) {
					$('#errorUpdateName').removeClass('off-element');
				}
				if (!validCount) {
					$('#errorUpdateCount').removeClass('off-element');
				}
				if (!validPrice) {
					$('#errorUpdatePrice').removeClass('off-element');
				}
			});
			// обновление списка(на удаление)
			$('#deleteElement').click(function() {
				elementArr.splice(numberElement, 1);
				// delete elementArr[numberElement];
				// deleteElementArr(numberElement);

				updateContent();
			});


			/* 
			* Utilities *
			* 			*/

			/* Обновление содержимого списка и вывод */
			function updateContent(request) {
				// сообщение о загрузке
				load.text('Loading...');
				// удаление предыдущего списка
				showData.empty();
				// вывод списка
				for (var i = 0; i < elementArr.length; i++) {
					// первая загрузка или пустой поиск - вывод полного списка
					if (request == '' || request == undefined) {
						// вывод 
						elementContent(elementArr[i].name, elementArr[i].count, elementArr[i].price, elementArr[i].id);

					} else {
						// вывод элементов списка по поисковому запросу					
						if (elementArr[i].name.toLowerCase().indexOf(request.toLowerCase()) > -1) {
							elementContent(elementArr[i].name, elementArr[i].count, elementArr[i].price, elementArr[i].id);
						}
					}
				}
				// удаление сообщения о загрузке 
				load.empty();

				console.log(elementArr);
			};

			/* Счеткик элеменетов */
			function idNumber() {
				countElementsOfArr++;
				return "id"+countElementsOfArr; 
			};

			/* Элемент таблицы */
			function elementContent(name, count, price, id) {
				showData.append('<tr><td>' 
					+ name 
					+ '<span class="table-count">' 
					+ count 
					+ '</span></td><td>$ ' 
					+ priceFormat(price) 
					+ '</td><td class="table-actions"><button type="button" class="btn btn-default" data-toggle="modal" data-target="#modalEdite" id="'
					+ id
					+ 'Edite">Edite</button><button type="button" class="btn btn-default" data-toggle="modal" data-target="#modalDelete" id="'
					+ id
					+'Delete">Delete</button></td></tr>');
			};

			/* Проверка данных */
			function validateName(name) {
				var count = 0;

				if (name.length > 15) {
					return false;
				}
				if (name == '') {
					return false;
				}
				for (var i = 0; i < name.length; i++) {
					if (name[i] == ' ') {
						count++;
					}
				}
				if (count == name.length) {
					return false;
				}

				return true;
			};
			function validateCount(count) {
				var tmp = 0;

				if (count == '') {
					return false;
				}
				if (isNaN(count)) {
					return false;
				}
				if (count < 0) {
					return false;
				}
				for (var i = 0; i < count.length; i++) {
					if (count[i] == ' ') {
						tmp++;
					}
				}
				if (tmp == count.length) {
					return false;
				}

				return true;
			};
			function validatePrice(price) {
				var count = 0;

				if (isNaN(price)) {
					return false;
				}
				if (price == '') {
					return false;
				}
				if (price < 0) {
					return false;
				}
				for (var i = 0; i < price.length; i++) {
					if (price[i] == ' ') {
						count++;
					}
				}
				if (count == price.length) {
					return false;
				}

				return true;
			};

			/* Вывод форматированной цены */
			function priceFormat(price) {
				
				// целое ли число
				if (price.indexOf('.') == -1) {
					price += ".00"
				} else {
					if (price.length - price.indexOf('.') > 2) {
						price = price.substr(0, price.indexOf('.')+3)
					} else {
						price += '0';
					}
				}

				for (var i = price.length-6; i >= 1; i-=3) {
					price = price.substr(0, i) + ',' + price.substr(i);
				}

				return price;
			};
		});

	/*
	* баги:
	* 3. по нажатию на энтер можно запустить поиск, т.е. и без кнопки search
	* 4. маленькая чувствительная часть у карретки для сортировок
	* 5. размещение модального окна ровно по центру экрана 
	* 6. игнорировать пробелы вначале и в конце в поисковых запросах
	* 7. поиск по фрагменту интерисуемого запроса
	*/
	</script>
</body>
</html>